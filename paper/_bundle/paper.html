<!-- MDKV: mdkv_paper -->
<!-- track:primary type:primary lang:en -->
<h1>MDKV: A Multitrack Markdown Container for Structured, Portable Documents</h1>
<p><strong>Daniel Ari Friedman</strong><br />
<a href="https://orcid.org/0000-0001-6232-9096">ORCID: 0000-0001-6232-9096</a><br />
<a href="mailto:daniel@activeinference.institute">daniel@activeinference.institute</a><br />
August 10, 2025<br />
<a href="https://doi.org/10.5281/zenodo.16790555">DOI: 10.5281/zenodo.16790555</a></p>
<h2>Abstract</h2>
<p>Digital knowledge work increasingly demands documents that are simultaneously multilingual, multi‑audience, and multi‑channel. Traditional single‑file Markdown struggles when the same canonical content must coexist with translations, commentary, references, code exemplars, and revision notes – each with distinct lifecycles and audiences. This paper introduces MDKV, a simple but rigorous multitrack Markdown container that packages a document’s canonical content and auxiliary tracks into a single, portable <code>.mdkv</code> file. An <code>.mdkv</code> is a ZIP archive with a YAML <code>manifest.yaml</code> and a <code>tracks/</code> directory of UTF‑8 Markdown files. MDKV provides a principled data model, validation, search, and export services, a CLI, and a small GUI for selective preview and live editing. We formalize the MDKV model, present its software architecture, explain round‑trip export semantics, and evaluate design trade‑offs against adjacent technologies. The MDKV initial specification is open source under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache‑2.0</a> license and maintained at the project repository (<code>https://github.com/docxology/mdkv</code>). We also situate MDKV with respect to Matroska (MKV) as background on containerization: although the two are orthogonal in domain (text vs. multimedia), they share conceptual lineage in extensible container design. We conclude with use cases, implications for governance and reproducibility, and future work such as richer validation rules and alternative exporters. This paper is itself a Markdown file that renders into a valid MDKV. The built artifact is available at <a href="https://github.com/docxology/mdkv/blob/main/paper/paper.mdkv">paper/paper.mdkv</a>; combined exports are under <a href="https://github.com/docxology/mdkv/tree/main/paper/_bundle">paper/_bundle</a>.</p>
<h2>1. Introduction</h2>
<p>Authoring, collaboration, and publishing workflows routinely require: (i) a single canonical text; (ii) multiple translations; (iii) audience‑specific commentary and references; (iv) code listings synchronized with the text; and (v) review and revision notes. Maintaining such layers in separate files and folders creates cognitive load and increases the risk of divergence. The central question is how to preserve a document’s conceptual unity while keeping its layers decoupled for editing, governance, and rendering.</p>
<p>MDKV addresses this need with a multitrack container for Markdown. Rather than overloading a single source with embedded annotations and language variants, MDKV separates concerns into tracks—<code>primary</code> (canonical), <code>translation</code>, <code>commentary</code>, <code>code</code>, <code>reference</code>, <code>media_ref</code>, and <code>revision</code>—and composes views at export time. The container format is intentionally modest: plain Markdown and YAML wrapped in ZIP, optimized for transparency, diff‑friendliness, and longevity.</p>
<p>Design motivations and lineage. MDKV applies general container principles (clear manifest, independent tracks, robust round‑trip) from adjacent domains to plaintext authoring. It favors human‑inspectable, durable primitives over custom binary formats, enabling simple tooling and long‑term readability. The initial public release standardizes a minimal spec and a reference implementation with CLI and GUI.</p>
<p>Contributions. (i) A precise model and container format with minimal but sufficient validation; (ii) a modular architecture separating model, storage, and services, surfaced via CLI and GUI; (iii) detailed use cases spanning multilingual publishing, layered collaboration, reproducible distribution, and governance; and (iv) guidance for cryptographic provenance and conformance.</p>
<h2>2. Background: Containerization for Documents and Media</h2>
<h3>2.1 Matroska (MKV): History and Technical Context</h3>
<p><a href="https://en.wikipedia.org/wiki/Matroska">Matroska (MKV)</a> is an open multimedia container format announced in 2002 as a fork of the Multimedia Container Format project, notably adopting <a href="https://en.wikipedia.org/wiki/Extensible_Binary_Meta_Language">EBML</a> to enable self‑describing, extensible binary structures. Over two decades, MKV matured into a widely supported container capable of packaging multiple video, audio, and subtitle streams, chapters, and rich metadata. Notable milestones include early stable releases, the emergence of <a href="https://en.wikipedia.org/wiki/WebM">WebM</a> as a web‑oriented subset, and native support in mainstream operating systems, underscoring the robustness and adaptability of a stream‑oriented, metadata‑rich container design. See also the official overview at <a href="https://www.matroska.org/what_is_matroska.html">matroska.org</a> for goals and feature summaries.</p>
<p>Technically, MKV exemplifies key container principles: a flexible root structure (via EBML), multiplexing of heterogeneous tracks, and resilience features that permit partial playback in the presence of corruption. These characteristics make MKV a useful conceptual antecedent for any domain where multiple orthogonal tracks must be co‑packaged without imposing codec‑level coupling.</p>
<p>Key timeline highlights:</p>
<ul>
<li>2004: First stable Matroska releases signaled production maturity.</li>
<li>2010: Google introduced <a href="https://en.wikipedia.org/wiki/WebM">WebM</a> as a web‑delivery subset of Matroska, emphasizing open codecs and browser playback.</li>
<li>2014: Microsoft announced native MKV support in Windows 10, cementing broad OS‑level adoption.</li>
</ul>
<h3>2.2 MDKV and MKV: Orthogonal Domains, Shared Intuition</h3>
<p>MDKV is not an MKV editor, wrapper, or derivative; it targets plaintext documents rather than multimedia. The similarity in names is intentional only insofar as both are “container‑centric” designs. MDKV borrows the intuition that many artifacts are multi‑track by nature, but it embraces a radically simpler substrate—<a href="https://commonmark.org">Markdown (CommonMark)</a>, <a href="https://yaml.org/spec/">YAML</a>, and <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">ZIP</a>—to maximize openness, inspectability, and compatibility with standard tooling. Where MKV multiplexes time‑based streams, MDKV co‑packages logically distinct textual layers.</p>
<h3>2.3 Why a textual container (vs. multimedia/EPUB/PDF)</h3>
<ul>
<li><strong>Keep primitives simple</strong>: plain Markdown + YAML + ZIP are ubiquitous, inspectable, and durable; no custom binary framing.</li>
<li><strong>Multi‑track authorship, not playback</strong>: MDKV is for co‑authoring and distributing textual layers in parallel; it is not a media streaming format.</li>
<li><strong>Deterministic composition</strong>: exports are reproducible from a manifest and track set, supporting provenance and verification.</li>
<li><strong>Toolchain leverage</strong>: downstream pipelines (e.g., <a href="https://pandoc.org">pandoc</a>) can consume <code>to_markdown()</code> outputs directly.</li>
<li><strong>Manage external assets</strong>: media stays outside via <code>media_ref</code> tracks, keeping bundles lean while links remain explicit and reviewable.</li>
<li><strong>Human‑first diffs</strong>: separate files per track minimize merge conflicts and make reviews targeted.</li>
<li><strong>Sovereign metadata</strong>: <code>manifest.yaml</code> is explicit and auditable; no hidden state.</li>
</ul>
<h2>3. MDKV Concept and Format</h2>
<h3>3.1 Overview</h3>
<p>An <code>.mdkv</code> file is a ZIP archive that contains:</p>
<ul>
<li><code>manifest.yaml</code>: top‑level document metadata and an index of tracks</li>
<li><code>tracks/</code>: UTF‑8 Markdown files, one per track</li>
</ul>
<p>The format is purposely simple for inspection and tooling: no custom filesystem or binary framing beyond ZIP, and no Markdown dialect beyond <a href="https://commonmark.org">CommonMark</a>‑compatible text.</p>
<h3>3.2 Manifest Schema</h3>
<p>Top‑level fields (required unless noted):</p>
<ul>
<li><code>title</code>: string</li>
<li><code>authors</code>: list[string] (at least one)</li>
<li><code>created</code>: ISO‑8601 datetime string</li>
<li><code>version</code>: string (optional; default &quot;0.1&quot;)</li>
<li><code>metadata</code>: object&lt;string,string&gt; (optional)</li>
<li><code>tracks</code>: list[Track] (optional at the schema level, but at least one <code>primary</code> track is required by validation)</li>
</ul>
<p>Track object fields:</p>
<ul>
<li><code>track_id</code>: string (unique within the document)</li>
<li><code>track_type</code>: one of <code>primary</code>, <code>translation</code>, <code>commentary</code>, <code>code</code>, <code>reference</code>, <code>media_ref</code>, <code>revision</code></li>
<li><code>language</code>: string or null (BCP‑47/ISO‑639 recommended for linguistic content)</li>
<li><code>path</code>: string (must start with <code>tracks/</code>; paths SHOULD end with <code>.md</code>)</li>
</ul>
<p>Example manifest:</p>
<pre><code class="language-yaml">title: Example
authors: [&quot;Author&quot;]
  created: 2025-01-01T00:00:00Z
version: &quot;0.1&quot;
metadata: {}
tracks:
  - track_id: primary
    track_type: primary
    language: en
    path: tracks/primary.md
  - track_id: notes
    track_type: commentary
    language: null
    path: tracks/notes.md
</code></pre>
<h4>3.2.1 Specification at a glance</h4>
<p>Field overview:</p>
<p>| Field | Type | Required | Notes |
|---|---|---|---|
| <code>title</code> | string | yes | Document title |
| <code>authors</code> | list[string] | yes | At least one author |
| <code>created</code> | ISO‑8601 string | yes | UTC recommended |
| <code>version</code> | string | no | Default &quot;0.1&quot; |
| <code>metadata</code> | map[string,string] | no | Freeform key/value pairs |
| <code>tracks</code> | list[Track] | schema‑optional | Validation requires at least one <code>primary</code> |</p>
<p>Track descriptor overview:</p>
<p>| Field | Type | Required | Notes |
|---|---|---|---|
| <code>track_id</code> | string | yes | Unique within the document |
| <code>track_type</code> | enum | yes | One of <code>primary, translation, commentary, code, reference, media_ref, revision</code> |
| <code>language</code> | string or null | no | BCP‑47 recommended for linguistic tracks |
| <code>path</code> | string | yes | Must start with <code>tracks/</code> |</p>
<h3>3.3 Multi‑track example (manifest + track bodies)</h3>
<p>Below is a compact, realistic multi‑track container using several track types side‑by‑side. This illustrates how translations, commentary, code listings, references, media references, and revisions live next to the canonical <code>primary</code> track.</p>
<p>Manifest:</p>
<pre><code class="language-yaml">title: Product Onboarding Guide
authors: [&quot;Tech Docs Team&quot;]
created: 2025-06-01T12:00:00Z
version: &quot;0.1&quot;
metadata:
  audience: &quot;customer, internal&quot;
tracks:
  - track_id: primary
    track_type: primary
    language: en
    path: tracks/primary.md
  - track_id: ru
    track_type: translation
    language: ru
    path: tracks/ru.md
  - track_id: zh
    track_type: translation
    language: zh
    path: tracks/zh.md
  - track_id: commentary
    track_type: commentary
    language: null
    path: tracks/commentary.md
  - track_id: snippets
    track_type: code
    language: null
    path: tracks/snippets.md
  - track_id: refs
    track_type: reference
    language: null
    path: tracks/refs.md
  - track_id: media
    track_type: media_ref
    language: null
    path: tracks/media.md
  - track_id: release_notes
    track_type: revision
    language: null
    path: tracks/release_notes.md
</code></pre>
<p>Track bodies (excerpts):</p>
<pre><code class="language-markdown">&lt;!-- track:primary type:primary lang:en --&gt;
# Welcome
Follow these steps to get started.

&lt;!-- track:ru type:translation lang:ru --&gt;
# Добро пожаловать
Выполните следующие шаги, чтобы начать.

&lt;!-- track:zh type:translation lang:zh --&gt;
# 欢迎
请按照以下步骤开始。

&lt;!-- track:commentary type:commentary lang:None --&gt;
Editors: confirm screenshots match v1.3 UI before release.

&lt;!-- track:snippets type:code lang:None --&gt;
```bash
uv run mdkv init --title &quot;Guide&quot; --author &quot;Docs&quot; --out guide.mdkv
```

&lt;!-- track:refs type:reference lang:None --&gt;
- Quickstart video: media:gui_demo.webm
- Markdown spec: https://commonmark.org

&lt;!-- track:media type:media_ref lang:None --&gt;
assets/gui_demo.webm  # external file shipped alongside exported package

&lt;!-- track:release_notes type:revision lang:None --&gt;
- 2025-06-15: Updated step 2 for new sign‑in flow.
</code></pre>
<p>Combined exports simply concatenate these bodies in the order present, preserving the headers for round‑trip reconstruction. Composition order follows the manifest track list order.</p>
<h3>3.4 This paper as an MDKV (self‑contained guidance)</h3>
<p>This Markdown file is authored to be round‑trip friendly for MDKV tooling. To package it as a <code>.mdkv</code>:</p>
<ol>
<li>Create <code>manifest.yaml</code> with at least one primary track and metadata:</li>
</ol>
<pre><code class="language-yaml">title: MDKV: A Multitrack Markdown Container for Structured, Portable Documents
authors: [&quot;Daniel Ari Friedman&quot;]
created: 2025-08-10T00:00:00Z
version: &quot;0.1&quot;
metadata:
  doi: &quot;10.5281/zenodo.16790555&quot;
  orcid: &quot;0000-0001-6232-9096&quot;
  contact: &quot;daniel@activeinference.institute&quot;
tracks:
  - track_id: primary
    track_type: primary
    language: en
    path: tracks/primary.md
</code></pre>
<ol>
<li>
<p>Place this file’s Markdown content (including the <code>&lt;!-- track:... --&gt;</code> header above) into <code>tracks/primary.md</code>.</p>
</li>
<li>
<p>Zip <code>manifest.yaml</code> and <code>tracks/</code> into <code>paper.mdkv</code> (use the CLI below), then validate.</p>
</li>
</ol>
<p>CLI (linked): see <a href="https://github.com/docxology/mdkv/blob/main/docs/cli.md"><code>docs/cli.md</code></a>. Minimal sequence:</p>
<pre><code class="language-bash">uv run mdkv init --title &quot;MDKV Paper&quot; --author &quot;Daniel Ari Friedman&quot; --out paper.mdkv
uv run mdkv update-track paper.mdkv --id primary --content &quot;$(cat paper/mdkv_paper.md)&quot;
uv run mdkv set-meta paper.mdkv doi 10.5281/zenodo.16790555
uv run mdkv validate paper.mdkv
uv run mdkv info paper.mdkv
</code></pre>
<h3>3.5 Validation Rules</h3>
<p>MDKV’s base validator enforces:</p>
<ul>
<li>Presence of <code>title</code>, <code>authors</code>, and at least one <code>primary</code> track</li>
<li>Track <code>path</code> begins with <code>tracks/</code></li>
<li><code>track_type</code> is one of the supported values</li>
<li><code>track_id</code> is non‑empty and unique</li>
<li><code>language</code> is either a BCP‑47 string or null</li>
</ul>
<p>The intentionally small rule set preserves extensibility while ensuring minimal integrity guarantees for downstream services.</p>
<p>Implementation note: the reference validator currently checks for the presence of a track with id <code>primary</code>; this could be aligned to the type‑level requirement in future releases.</p>
<h3>3.6 Round‑Trip Export Headers</h3>
<p>When exporting multiple tracks into a single Markdown stream, MDKV prefixes each track with a lightweight HTML comment that encodes track metadata. These hints enable round‑trip attribution and reconstruction without altering the track files in the container:</p>
<pre><code class="language-markdown">&lt;!-- track:primary type:primary lang:en --&gt;
Title

&lt;!-- track:notes type:commentary lang:None --&gt;
Editorial notes here
</code></pre>
<h3>3.7 Normative Container Requirements (Conformance)</h3>
<p>The MDKV container is defined by the following MUST/SHOULD requirements:</p>
<ul>
<li>A valid <code>.mdkv</code> MUST be a ZIP archive containing a root‑level <code>manifest.yaml</code> and a <code>tracks/</code> directory.</li>
<li><code>manifest.yaml</code> MUST be a valid YAML mapping with fields: <code>title</code> (string), <code>authors</code> (list of strings, non‑empty), <code>created</code> (ISO‑8601 string), and optionally <code>version</code> (string, default &quot;0.1&quot;), <code>metadata</code> (mapping), and <code>tracks</code> (list of track descriptors).</li>
<li>Each track descriptor MUST include <code>track_id</code> (unique string), <code>track_type</code> (one of the allowed values), <code>language</code> (string or null), and <code>path</code> (string beginning with <code>tracks/</code>).</li>
<li>At least one track with <code>track_type: primary</code> MUST be present.</li>
<li>For round‑trip combined Markdown exports, each included track MUST be prefixed by an HTML comment header of the form: <code>&lt;!-- track:{id} type:{type} lang:{lang} --&gt;</code>.</li>
<li>Implementations SHOULD preserve field ordering in <code>manifest.yaml</code> for human readability, though ordering is not semantically significant.</li>
<li>Implementations SHOULD emit UTF‑8 for all track files and SHOULD NOT assume line ending conventions beyond standard text processing.</li>
</ul>
<h3>3.8 Conformance Levels</h3>
<ul>
<li>Core Conformance: satisfies all MUST requirements above and passes validation.</li>
<li>Extended Conformance: additionally supports selective export by track type and language filters, and preserves track headers for round‑trip workflows.</li>
</ul>
<h3>3.9 Design principles</h3>
<ul>
<li>Simplicity first: rely on ubiquitous primitives (ZIP, YAML, Markdown) to maximize longevity and inspectability.</li>
<li>Separation of concerns: keep tracks orthogonal; orchestrate at export time rather than embedding format‑specific directives into bodies.</li>
<li>Round‑trip fidelity: preserve attribution via headers so combined streams can be losslessly de‑multiplexed.</li>
<li>Deterministic composition: identical manifests and track sets produce identical exports to support reproducible publishing.</li>
<li>Extensibility: add tracks and exporters without changing the core model or on‑disk layout.</li>
</ul>
<h3>3.10 Limitations of the format</h3>
<ul>
<li><strong>No encryption or signing baked in</strong>: use external tools for security (see Security and provenance guidance).</li>
<li><strong>Not an execution environment</strong>: <code>code</code> tracks are listings, not runnable notebooks; execution belongs to downstream systems.</li>
<li><strong>No enforced cross‑track alignment</strong>: paragraph‑level alignment between tracks is a convention, not a rule.</li>
<li><strong>Binary assets live outside</strong>: large media is referenced via <code>media_ref</code> instead of embedded to keep bundles lean and editable.</li>
<li><strong>No cross‑doc linking semantics</strong>: references across containers are conventional; not part of the base spec.</li>
<li><strong>Time semantics are shallow</strong>: <code>created</code> is recorded; versioning/history are external concerns.</li>
</ul>
<h2>4. Software Architecture</h2>
<p>MDKV follows a thin‑orchestrator, modular architecture:</p>
<ul>
<li><code>mdkv.core</code>: data model and validation</li>
<li><code>mdkv.storage</code>: persistence (read/write <code>.mdkv</code>)</li>
<li><code>mdkv.services</code>: search and export utilities</li>
<li><code>mdkv.cli</code>: CLI entry points and subcommands</li>
</ul>
<p>This separation enables stable public APIs, testable modules, and straightforward extension.</p>
<h3>4.1 Core Model (<code>mdkv.core</code>)</h3>
<p>The core defines two primary classes:</p>
<ul>
<li><code>Track</code>: a single Markdown track with <code>track_id</code>, <code>track_type</code>, <code>language</code>, <code>path</code>, <code>content</code>, and invariant checks (valid type, non‑empty id, <code>path</code> under <code>tracks/</code>).</li>
<li><code>MDKVDocument</code>: an in‑memory aggregate with metadata (<code>title</code>, <code>authors</code>, <code>created</code>, <code>version</code>, and <code>metadata</code> map) and a mapping <code>track_id → Track</code>. It provides helpers for adding/removing tracks, renaming, content updates, language listing, and metadata set/get/remove.</li>
<li>Invariants are validated eagerly on construction and update; violations raise narrow exceptions (<code>ValueError</code>, <code>ValidationError</code>).</li>
</ul>
<p>The core also surfaces <code>allowed_track_types()</code> and validation types (<code>ValidationError</code>, <code>ValidationIssue</code>).</p>
<h3>4.2 Storage (<code>mdkv.storage</code>)</h3>
<p>ZIP + YAML persistence:</p>
<ul>
<li><code>save_mdkv(doc, output_path)</code>: write tracks under <code>tracks/</code> and emit <code>manifest.yaml</code> from the document.</li>
<li><code>load_mdkv(input_path)</code>: parse the manifest and reconstruct the document, loading each track’s content.</li>
</ul>
<p>The manifest lists metadata and track descriptors; bodies remain discrete files for transparency and editability.</p>
<h3>4.3 Services (<code>mdkv.services</code>)</h3>
<p>Two primary services operate over <code>MDKVDocument</code> instances:</p>
<ul>
<li>Search: regex search with optional filters by <code>track_type</code> and <code>language</code>, returning match structures suitable for CLI/GUI display.</li>
<li>Export: composition of multi‑track Markdown via <code>to_markdown()</code> and primary‑track HTML via <code>to_html()</code> using <a href="https://github.com/executablebooks/markdown-it-py">markdown‑it‑py</a>. <code>export_to_files()</code> writes selected tracks to individual <code>.md</code> files for channel‑specific distribution.</li>
<li>Export determinism: order is manifest‑driven; identical inputs produce identical outputs.</li>
</ul>
<h3>4.4 CLI (<code>mdkv.cli</code>)</h3>
<p>Thin orchestrators for: init, info, validate, track ops, search, export, metadata, and GUI. Commands call module APIs directly for testability and minimal command‑layer logic.</p>
<h3>4.5 GUI (<code>mdkv.gui</code>)</h3>
<p>The optional GUI offers a live preview and editing workflow with track selection via checkboxes. A backend endpoint (<code>POST /api/render/tracks_html</code>) renders arbitrary track subsets, while the visual editor maintains a full combined view with live persistence per track. Additional endpoints include <code>GET /api/render/html</code> (primary HTML) and <code>GET /api/render/markdown</code> (combined Markdown). The GUI is intended as an affordance for users uncomfortable with the CLI while preserving parity with programmatic workflows. State is ephemeral; persistence uses the same <code>save_mdkv</code> path as the CLI.</p>
<h3>4.6 Architecture overview (linked)</h3>
<ul>
<li>Layers and responsibilities: see <a href="https://github.com/docxology/mdkv/blob/main/docs/architecture.md"><code>docs/architecture.md</code></a> and the published docs site.</li>
<li>Core model: <a href="https://github.com/docxology/mdkv/blob/main/mdkv/core/model.py"><code>mdkv/core/model.py</code></a> defines <code>Track</code>, <code>MDKVDocument</code>, and invariants; re‑exported via <a href="https://github.com/docxology/mdkv/blob/main/mdkv/__init__.py"><code>mdkv/__init__.py</code></a>.</li>
<li>Storage: <a href="https://github.com/docxology/mdkv/blob/main/mdkv/storage/io.py"><code>mdkv/storage/io.py</code></a> implements <code>save_mdkv</code> and <code>load_mdkv</code> (ZIP + YAML manifest and <code>tracks/</code>).</li>
<li>Services: export in <a href="https://github.com/docxology/mdkv/blob/main/mdkv/services/export.py"><code>mdkv/services/export.py</code></a> (<code>to_markdown</code>, <code>to_html</code>, <code>export_to_files</code>); search in <a href="https://github.com/docxology/mdkv/blob/main/mdkv/services/search.py"><code>mdkv/services/search.py</code></a>. Both are re‑exported at the top‑level package for a stable public API.</li>
<li>CLI: <a href="https://github.com/docxology/mdkv/blob/main/mdkv/cli/main.py"><code>mdkv/cli/main.py</code></a> surfaces subcommands (init, info, validate, track ops, search, export, gui).</li>
<li>GUI backend: <a href="https://github.com/docxology/mdkv/blob/main/mdkv/gui/server.py"><code>mdkv/gui/server.py</code></a> provides <code>POST /api/render/tracks_html</code> for subset rendering; static assets under <a href="https://github.com/docxology/mdkv/tree/main/mdkv/gui/static"><code>mdkv/gui/static/</code></a>.</li>
</ul>
<p>Data flow summary (see also the repository <code>README.md</code> and docs pages):</p>
<ul>
<li>Authoring: create or load an <code>MDKVDocument</code>, add tracks; validate.</li>
<li>Persistence: <code>save_mdkv</code> writes <code>tracks/</code> and <code>manifest.yaml</code> into a <code>.mdkv</code> ZIP; <code>load_mdkv</code> reconstructs.</li>
<li>Services: <code>search_document</code> filters/matches; <code>to_markdown</code> and <code>to_html</code> export views; <code>export_to_files</code> writes per‑track files. For end‑to‑end CLI usage, see <a href="https://github.com/docxology/mdkv/blob/main/docs/cli.md"><code>docs/cli.md</code></a>.</li>
</ul>
<h2>5. Public API and Re‑Exports</h2>
<p>The top‑level <code>mdkv</code> package re‑exports the public API to provide a stable surface:</p>
<ul>
<li><code>MDKVDocument</code>, <code>Track</code>, <code>allowed_track_types</code>, <code>ValidationError</code>, <code>validate_document</code>, <code>ValidationIssue</code></li>
<li><code>search_document</code>, <code>SearchMatch</code>, <code>to_markdown</code>, <code>to_html</code>, <code>export_to_files</code></li>
<li><code>save_mdkv</code>, <code>load_mdkv</code></li>
</ul>
<p>This consolidation supports both script‑level usage and library integrations without deep import paths.</p>
<h2>6. Usage</h2>
<h3>6.1 Quickstart</h3>
<pre><code class="language-bash"># install uv once per machine (Linux/macOS)
curl -LsSf https://astral.sh/uv/install.sh | sh

# from repo root
uv venv
uv run pytest -q
uv run mdkv --help
</code></pre>
<h3>6.2 Create, Inspect, Validate</h3>
<pre><code class="language-bash">uv run mdkv init --title &quot;Doc&quot; --author &quot;You&quot; --out doc.mdkv
uv run mdkv info doc.mdkv
uv run mdkv validate doc.mdkv
</code></pre>
<h3>6.3 Track Operations</h3>
<pre><code class="language-bash">uv run mdkv list-tracks doc.mdkv
uv run mdkv add-track doc.mdkv --id notes --type commentary --lang &quot;&quot; --content &quot;Note&quot;
uv run mdkv rename-track doc.mdkv --old-id notes --new-id commentary
uv run mdkv update-track doc.mdkv --id commentary --content &quot;Updated note&quot;
</code></pre>
<h3>6.4 Export and GUI</h3>
<pre><code class="language-bash"># export selected track types to Markdown
uv run mdkv export-tracks doc.mdkv --types primary,commentary &gt; exported.md

# export HTML of primary track
uv run mdkv export --html doc.mdkv &gt; primary.html

# launch GUI
uv run mdkv gui --path doc.mdkv
</code></pre>
<h3>6.5 Programmatic Export</h3>
<pre><code class="language-python">from pathlib import Path
from datetime import datetime
from mdkv import MDKVDocument, Track, export_to_files, to_markdown, save_mdkv, validate_document

# write selected tracks as individual .md files
doc = MDKVDocument(title=&quot;Doc&quot;, authors=[&quot;You&quot;], created=datetime.utcnow(), version=&quot;0.1&quot;)
doc.add_track(Track(track_id=&quot;primary&quot;, track_type=&quot;primary&quot;, language=&quot;en&quot;, path=&quot;tracks/primary.md&quot;, content=&quot;# Hello\n&quot;))

# validate, save, export
validate_document(doc)
save_mdkv(doc, Path(&quot;doc.mdkv&quot;))
export_to_files(doc, Path(&quot;out_tracks&quot;), include_track_types=[&quot;primary&quot;, &quot;commentary&quot;])

# combined markdown (for pandoc or review)
combined_md = to_markdown(doc)
Path(&quot;combined.md&quot;).write_text(combined_md, encoding=&quot;utf-8&quot;)
</code></pre>
<h3>6.6 End‑to‑end: create a multi‑track paper</h3>
<pre><code class="language-bash"># 1) Initialize
uv run mdkv init --title &quot;Paper&quot; --author &quot;Author&quot; --out paper.mdkv

# 2) Add tracks
uv run mdkv add-track paper.mdkv --id ru --type translation --lang ru --content &quot;# Резюме\n...&quot;
uv run mdkv add-track paper.mdkv --id zh --type translation --lang zh --content &quot;# 摘要\n...&quot;
uv run mdkv add-track paper.mdkv --id commentary --type commentary --content &quot;Editors: tighten abstract.&quot;
uv run mdkv add-track paper.mdkv --id code --type code --content &quot;```bash\nuv run pytest -q\n```&quot;
uv run mdkv add-track paper.mdkv --id refs --type reference --content &quot;- CommonMark: https://commonmark.org&quot;
uv run mdkv add-track paper.mdkv --id media --type media_ref --content &quot;docs/_static/gui_demo.webm&quot;
uv run mdkv add-track paper.mdkv --id revisions --type revision --content &quot;- 2025-08-10: camera‑ready edits&quot;

# 3) Inspect and validate
uv run mdkv list-tracks paper.mdkv | jq .
uv run mdkv validate paper.mdkv

# 4) Search (only Russian translations for TODO/FIXME)
uv run mdkv search paper.mdkv --pattern &quot;TODO|FIXME&quot; --types translation --languages ru | jq .

# 5) Export views
uv run mdkv export-tracks paper.mdkv --types primary,translation &gt; combined.md
uv run mdkv export --html paper.mdkv &gt; primary.html
</code></pre>
<h2>7. Data Model: Semantics of Tracks</h2>
<p>MDKV’s track taxonomy encodes common document layers:</p>
<ul>
<li><code>primary</code>: canonical content intended for publication and primary consumption.</li>
<li><code>translation</code>: language alternatives to <code>primary</code>, preserving structure but adapting language and, where necessary, locale.</li>
<li><code>commentary</code>: annotations, editorial notes, and audience‑specific guidance; excluded by default from canonical exports.</li>
<li><code>code</code>: code listings and examples that remain synchronized with the narrative; not intended as executed notebooks.</li>
<li><code>reference</code>: citations and reference lists, metadata‑heavy but typically orthogonal to <code>primary</code> structure.</li>
<li><code>media_ref</code>: references to external media (figures, videos) that are managed outside the container but linked textually.</li>
<li><code>revision</code>: review notes and change summaries; useful for governance, release notes, and compliance trails.</li>
</ul>
<p>Semantically, MDKV treats tracks as parallel layers; it does not prescribe alignment at paragraph or section granularity. Alignment strategies (e.g., anchor conventions) can be layered atop the format by convention when needed.</p>
<h2>8. Validation and Integrity</h2>
<p>Minimal by design to maximize compatibility while catching common integrity issues. Optional profiles can enforce stricter policies (e.g., translation coverage, mandatory references) without compromising baseline portability. See Appendix C for an example of bundle metadata and checksums emitted by the paper builder.</p>
<h3>8.1 Common validation errors and remedies</h3>
<ul>
<li><strong>Missing <code>primary</code> track</strong>: Add at least one <code>primary</code> track; ensure <code>track_type: primary</code>.</li>
<li><strong>Invalid track <code>path</code></strong>: Ensure <code>path</code> starts with <code>tracks/</code> and corresponds to a file in the container.</li>
<li><strong>Unknown <code>track_type</code></strong>: Use only the allowed set; see section 7.</li>
<li><strong>Empty <code>authors</code></strong>: Provide at least one author string.</li>
<li><strong>Malformed <code>created</code></strong>: Use ISO‑8601 (e.g., <code>2025-08-10T00:00:00Z</code>).</li>
<li><strong>Duplicate <code>track_id</code></strong>: Ensure each <code>track_id</code> is unique; rename or remove conflicts.</li>
<li><strong>Bad <code>track_type</code> change</strong>: When changing a track’s type, ensure downstream exporters are aware of filtering.</li>
</ul>
<h2>9. Search and Export</h2>
<p>Regex search across selected tracks and languages enables cross‑cutting queries (e.g., beta‑flagged commentary in Spanish). Export is deterministic given a manifest and track set:</p>
<ul>
<li>Multi‑track Markdown: concatenates track bodies with track headers for round‑trip attribution and optional filtering by track type.</li>
<li>HTML (primary): renders the <code>primary</code> track to HTML for simple distribution channels, leveraging a standard Markdown engine.</li>
<li>File export: writes track contents to discrete <code>.md</code> files for downstream pipelines.</li>
</ul>
<p>These capabilities support reproducible publishing.</p>
<p>Programmatic search is available via <code>mdkv.services.search.search_document(doc, pattern, track_types=None, languages=None)</code>; the CLI mirrors this with <code>uv run mdkv search &lt;path&gt; --pattern PATTERN [--types ...] [--languages ...]</code>.
For combined exports intended for downstream tools (e.g., pandoc), keep round‑trip headers intact to preserve provenance.</p>
<h2>10. Implementation Notes</h2>
<ul>
<li>Python 3.9+; dataclasses and type hints; explicit naming.</li>
<li>Packaging: public API re‑exports; CLI entry point <code>mdkv</code>.</li>
<li>Dependencies: YAML, ZIP (std lib), Markdown renderer for HTML export.</li>
<li>Tests: cover CLI, services, model invariants, and storage round‑trip.</li>
</ul>
<h2>11. Use Cases</h2>
<h3>11.1 Multilingual publishing and localization</h3>
<ul>
<li>Goal: ship a single canonical text to multiple locales without forking.</li>
<li>Tracks: <code>primary</code> (en), <code>translation</code> (ru, zh, …).</li>
<li>Flow: author in <code>primary</code>; translators add language tracks; QA searches for unresolved tags (e.g., TODO) scoped to translations; export per‑locale Markdown/HTML.</li>
<li>Benefit: eliminates redundant branching; preserves structure and provenance across locales.</li>
<li>Notes: reserve <code>track_id</code> values for ISO language tags where possible (e.g., <code>ru</code>, <code>zh-Hans</code>).</li>
</ul>
<h3>11.2 Layered collaboration, review, and stakeholder tailoring</h3>
<ul>
<li>Goal: separate canonical narrative from internal commentary and change rationale.</li>
<li>Tracks: <code>commentary</code>, <code>revision</code> alongside <code>primary</code>.</li>
<li>Flow: reviewers annotate in <code>commentary</code>; change summaries accrue in <code>revision</code>; public exports omit commentary; internal exports include it for audit and coaching.</li>
<li>Benefit: clean public artifacts with rich internal discourse and governance trails.</li>
<li>Notes: treat <code>revision</code> as append‑only; include date stamps for traceability.</li>
</ul>
<h3>11.3 Developer documentation with synchronized code listings</h3>
<ul>
<li>Goal: keep examples synced with docs and ship channel‑specific bundles.</li>
<li>Tracks: <code>code</code> for listings; optional <code>media_ref</code> for demos.</li>
<li>Flow: update code listings in <code>code</code>; search across <code>code</code> and <code>primary</code> for API drift; export code‑only bundles for IDE extensions and full docs for websites.</li>
<li>Benefit: reduces drift between narrative and examples; supports tailored distribution.</li>
<li>Notes: pair <code>code</code> listings with tested snippets in CI; consider tangling to source when appropriate.</li>
</ul>
<h3>11.4 Scholarly and technical writing with curated references</h3>
<ul>
<li>Goal: bundle narrative with references and domain annotations.</li>
<li>Tracks: <code>reference</code> for citations/bibliography; optional <code>commentary</code> for reviewer notes.</li>
<li>Flow: maintain references in <code>reference</code>; export tight submissions without commentary; archive complete <code>.mdkv</code> with all layers for reproducibility.</li>
<li>Benefit: transparent, reproducible artifacts while enabling audience‑specific exports.</li>
<li>Notes: adopt a citation style within <code>reference</code> tracks and keep DOIs/URLs explicit.</li>
</ul>
<h3>11.5 Governance, compliance, and audit trails</h3>
<ul>
<li>Goal: capture intent and decision history without imposing a VCS workflow on recipients.</li>
<li>Tracks: <code>revision</code> for change logs; <code>metadata</code> for release info.</li>
<li>Flow: record rationale per release in <code>revision</code>; embed DOI, version, or policy IDs in <code>metadata</code>; export for auditors or regulators with selected layers.</li>
<li>Benefit: lightweight provenance and traceability without heavy infrastructure.</li>
<li>Notes: use checksums/signatures described in Appendix C to support integrity attestations.</li>
</ul>
<h3>11.6 Product, policy, and dual‑audience documentation</h3>
<ul>
<li>Goal: publish the same canonical content to internal and external audiences.</li>
<li>Tracks: <code>commentary</code> (internal notes), <code>reference</code> (appendices), <code>media_ref</code> (assets).</li>
<li>Flow: export public bundles from <code>primary</code> only; export internal bundles with commentary and references for onboarding/support teams.</li>
<li>Benefit: single source of truth with audience‑appropriate views.</li>
<li>Notes: mark internal commentary with a prefix (e.g., <code>INTERNAL:</code>) to aid filtering.</li>
</ul>
<h3>11.7 Digital archiving and long‑term preservation</h3>
<ul>
<li>Goal: store durable, inspectable artifacts that migrate across tools.</li>
<li>Tracks: all, with emphasis on <code>manifest.yaml</code> readability.</li>
<li>Flow: write <code>.mdkv</code> for archives; include checksums and optional signatures; consumers can inspect and transform with standard tooling.</li>
<li>Benefit: longevity and portability via ubiquitous primitives (ZIP, YAML, Markdown).</li>
<li>Notes: include <code>BUNDLE_INFO.yaml</code> with source commit metadata when available.</li>
</ul>
<h2>12. Implications</h2>
<ul>
<li>Governance: <code>revision</code> + metadata expose intent and review structure.</li>
<li>Reproducibility: deterministic export + manifest versioning.</li>
<li>Interoperability: ubiquitous primitives (ZIP, YAML, Markdown).</li>
<li>Diff‑friendliness: semantic separation reduces merge conflicts.</li>
<li>Extensibility: add track types/exporters without core changes.</li>
<li>Supply‑chain clarity: explicit manifests and deterministic builds simplify reproducibility and review.</li>
</ul>
<h3>Licensing and community</h3>
<ul>
<li><strong>License</strong>: Apache‑2.0. See <a href="https://github.com/docxology/mdkv/blob/main/LICENSE">LICENSE</a> in the repository.</li>
<li><strong>Source &amp; issues</strong>: development and issue tracking on the <a href="https://github.com/docxology/mdkv">GitHub repository</a>.</li>
<li><strong>Contributions</strong>: small, focused pull requests preferred; tests and docs alongside changes.</li>
</ul>
<h3>Security and Privacy Considerations</h3>
<ul>
<li><code>.mdkv</code> bundles are not encrypted; sensitive content SHOULD be managed with appropriate transport and storage controls (e.g., encryption at rest, signed artifacts).</li>
<li><code>metadata</code> may contain personally identifiable information; producers SHOULD minimize PII and consumers SHOULD handle metadata under applicable policies.</li>
<li>Track headers in exported Markdown are informational; avoid embedding secrets in headers or comments.</li>
<li>Validation is minimal by design; distributors SHOULD layer additional checks where provenance and integrity are critical (e.g., checksums, signatures).</li>
</ul>
<h3>Cryptographic provenance and signing</h3>
<ul>
<li>Manifest and track checksums: producers MAY compute SHA‑256 (or stronger) digests for each file and include them in <code>metadata</code> for integrity verification after transport.</li>
<li>Container signing: producers MAY sign the <code>.mdkv</code> archive (e.g., using minisign or GPG) and distribute the signature alongside the artifact. Consumers SHOULD verify signatures prior to ingest in security‑sensitive contexts.</li>
<li>Reproducible builds: deterministic export semantics enable consistent digests across builds from the same manifest/tracks. Consumers SHOULD compare published checksums against local builds when a source repository is available.</li>
<li>Threat model notes: MDKV is plaintext‑oriented and does not execute code; however, downstream pipelines (e.g., HTML renderers) SHOULD sanitize untrusted Markdown before display.</li>
</ul>
<h3>Interoperability and Migration Guidance</h3>
<ul>
<li>Content SHOULD be authored in CommonMark‑compatible Markdown to maximize renderer compatibility.</li>
<li>For downstream channels (PDF/EPUB), use <code>to_markdown()</code> with pandoc‑compatible flags/templates; retain track headers to assist provenance.</li>
<li>When migrating legacy multi‑file projects, prefer one‑track‑per‑file mapping under <code>tracks/</code> and encode provenance in <code>metadata</code>.</li>
</ul>
<h2>13. Related Work and Positioning</h2>
<ul>
<li>Matroska (MKV): multimedia container with EBML, multiplexing heterogeneous streams and metadata. Conceptually adjacent as a container design; orthogonal in domain (binary streams vs. plaintext tracks).</li>
<li>CommonMark: Markdown specification underpinning content rendering; MDKV does not introduce dialect changes.</li>
<li>EPUB/PDF pipelines: rich, distribution‑focused bundles; MDKV targets authoring/editing unity and channel‑agnostic composition, and can serve as an upstream source for such exporters.</li>
<li>Jupyter notebooks: literate, executable documents combining code and text; MDKV focuses on non‑executable, layered textual artifacts with optional code listings.</li>
</ul>
<h2>14. Future Work</h2>
<ul>
<li>Validation profiles: optional, stricter validators (coverage constraints, reference bibliography schemas).</li>
<li>Alternate exporters: PDF/EPUB builders atop <code>to_markdown()</code>, pandoc interop, and track‑aware templates.</li>
<li>Track alignment aids: soft anchors and cross‑track link conventions for advanced localization/review.</li>
<li>Provenance and signing: cryptographic checksums and signatures for manifests and tracks.</li>
<li>Remote storage: mapping tracks to object stores while preserving a virtual manifest.</li>
<li>Richer GUI: per‑track editing affordances, diff views, and translation workflows.</li>
</ul>
<h2>15. Conclusion</h2>
<p>MDKV introduces a practical, minimal, and extensible approach to multitrack textual documents. By embracing simple, durable primitives (Markdown, YAML, ZIP) and separating core modeling from storage and services, MDKV enables multilingual and multi‑audience authoring without branching, improves governance through explicit layer semantics, and supports reproducible publishing. As the ecosystem evolves, MDKV can integrate stronger validation profiles and richer exporters while preserving its core promise: a small, inspectable container for structured documents that travels well and ages gracefully.</p>
<h2>References</h2>
<ul>
<li>Matroska (MKV) overview: <a href="https://en.wikipedia.org/wiki/Matroska">Wikipedia</a></li>
<li>CommonMark specification: <a href="https://commonmark.org">commonmark.org</a></li>
<li>YAML 1.2 specification: <a href="https://yaml.org/spec/">yaml.org/spec</a></li>
<li>ZIP Appnote (PKWARE): <a href="https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT">PKWARE Appnote</a></li>
<li>markdown‑it‑py project: <a href="https://github.com/executablebooks/markdown-it-py">executablebooks/markdown-it-py</a></li>
<li>Astral uv project: <a href="https://github.com/astral-sh/uv">astral-sh/uv</a></li>
</ul>
<h2>Appendix A: Glossary</h2>
<ul>
<li>MDKV: Multitrack Markdown container defined by this specification.</li>
<li>Track: A named, typed Markdown layer within an MDKV document (e.g., <code>primary</code>, <code>translation</code>).</li>
<li>Manifest: YAML file at the root of the container that indexes tracks and captures metadata.</li>
<li>Round‑trip: Ability to reconstruct track attribution from a combined export using embedded headers.</li>
<li>Conformance: Degree to which an implementation satisfies normative requirements in this document.</li>
</ul>
<h2>Appendix B: Track header grammar</h2>
<p>The header used for round‑trip exports follows a simple, stable grammar:</p>
<pre><code class="language-text">&lt;!--\s+track:{track_id}\s+type:{track_type}\s+lang:{language}\s+--&gt;
</code></pre>
<p>When language is unspecified, the literal text <code>None</code> is emitted for <code>{language}</code>.</p>
<h3>6.7 Pandoc pipeline (PDF)</h3>
<pre><code class="language-bash"># render primary track to Markdown, then to PDF with pandoc
uv run mdkv export paper.mdkv &gt; primary.md
pandoc primary.md -o primary.pdf
</code></pre>
<h3>6.8 Inspect and verify</h3>
<pre><code class="language-bash"># show manifest summary and tracks
uv run mdkv info paper.mdkv | sed -n '1,60p'

# validate and list tracks
uv run mdkv validate paper.mdkv
uv run mdkv list-tracks paper.mdkv
</code></pre>
<h3>6.9 When to choose MDKV</h3>
<ul>
<li>
<p><strong>You need layered authorship</strong>: separate canonical text, translations, commentary, references, code listings, and revisions without branching the project.</p>
</li>
<li>
<p><strong>You want reproducible bundles</strong>: deterministic exports and manifest‑driven structure make builds auditable.</p>
</li>
<li>
<p><strong>You prefer plain text pipelines</strong>: leverage Markdown/YAML and existing tools (git, grep, pandoc) rather than custom ecosystems.</p>
</li>
<li>
<p><strong>You need selective exports</strong>: tailor output by track types and languages for different audiences/channels.</p>
</li>
<li>
<p><strong>You need to be able to edit the document via multiple tools</strong>: MDKV is a container for text, not a text editor.</p>
</li>
<li>
<p><strong>You want to use an open source format to ensure long-term compatibility</strong>: MDKV is a small, simple, modular, and well-documented format that is licensed under the Apache 2.0 license.</p>
</li>
<li>
<p><code>track_id</code>: string, unique per document</p>
</li>
<li>
<p><code>track_type</code>: one of <code>primary, translation, commentary, code, reference, media_ref, revision</code></p>
</li>
<li>
<p><code>language</code>: BCP‑47 code or <code>None</code></p>
</li>
</ul>
<h2>Appendix C: Example bundle artifacts</h2>
<p>This appendix sketches the files created by the builder (<code>paper/build_paper_bundle.py</code>) to support reproducible publication and verification.</p>
<ul>
<li><code>paper/paper.mdkv</code>: ZIP archive with <code>manifest.yaml</code> and <code>tracks/</code> (e.g., <code>tracks/primary.md</code>, optional <code>tracks/references.md</code>).</li>
<li><code>paper/_bundle/paper.md</code>: combined multi‑track Markdown export from <code>to_markdown()</code>.</li>
<li><code>paper/_bundle/paper.html</code>: HTML of the <code>primary</code> track from <code>to_html()</code>.</li>
<li><code>paper/_bundle/tracks/</code>: individual per‑track Markdown files exported for distribution pipelines.</li>
<li><code>paper/_bundle/BUNDLE_INFO.yaml</code>: bundle metadata (source path, timestamps, clone info, commit hashes when available).</li>
<li><code>paper/_bundle/CHECKSUMS.yaml</code>: SHA‑256 digests of <code>paper.mdkv</code> and exported files to enable integrity checks.</li>
</ul>
<p>Example excerpt of <code>BUNDLE_INFO.yaml</code>:</p>
<pre><code class="language-yaml">generated_at: 2025-08-10T12:34:56Z
source_markdown: /abs/path/paper/mdkv_paper.md
output_mdkv: /abs/path/paper/paper.mdkv
repo_url: https://github.com/docxology/mdkv
cloned_commit: 0123abcd...
builder_commit: 89ef4567...
</code></pre>
<p>Example excerpt of <code>CHECKSUMS.yaml</code>:</p>
<pre><code class="language-yaml">_bundle/paper.html: 7f4c2b...
_bundle/paper.md: 8b91fe...
_bundle/tracks/primary.md: 0b12aa...
paper.mdkv: 5c44d1...
</code></pre>
